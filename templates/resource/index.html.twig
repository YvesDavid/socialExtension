{% extends 'base.html.twig' %}

{% block title %}Ressources{% endblock %}

{% block styles %}
<style>
    .file-layout {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        gap: 1.5rem;
    }

    .sidebar {
        background: #ffffff;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: .75rem;
    }

    .sidebar-nav {
        overflow-y: auto;
        padding-right: .25rem;
    }

    .file-tree li {
        margin: .15rem 0;
        font-size: .95rem;
    }

    .file-tree a {
        color: #111827;
        text-decoration: none;
    }

    .file-tree a:hover {
        text-decoration: underline;
    }

    .content-panel {
        background: #ffffff;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .breadcrumb-small a {
        color: #6b7280;
        text-decoration: none;
    }

    .breadcrumb-small a:hover {
        text-decoration: underline;
    }

    .resource-row:hover {
        background-color: #f9fafb;
    }

    /* Modal custom */
    .modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 1050;
    }
    .modal-backdrop-custom {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
    }
    .modal-dialog-centered-custom {
        position: relative;
        max-width: 480px;
        margin: 8vh auto;
        z-index: 1060;
    }
    .modal-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 1.5rem 1.75rem;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.32);
    }
</style>
{% endblock %}

{% block body %}
<div class="file-layout">

    {# Sidebar gauche : arborescence #}
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-folder2-open"></i>
                <span class="fw-semibold">Folders</span>
            </div>
        </div>

        <div class="sidebar-nav">
            <ul class="list-unstyled file-tree" id="file-tree-root">
                {% for folder in root_folders %}
                    {% include 'resource/_folder_tree_item.html.twig' with { folder: folder } %}
                {% else %}
                    <li class="text-muted small">No folders yet.</li>
                {% endfor %}
            </ul>
        </div>
    </aside>

    {# Contenu droit #}
    <section class="content-panel">
        <div class="toolbar">
            <div>
                <h4 class="mb-1">
                    {% if parent %}
                        {{ parent.title }}
                    {% else %}
                        Home
                    {% endif %}
                </h4>
                <div class="breadcrumb-small small text-muted">
                    {% if parent %}
                        <a href="{{ path('app_resources_index') }}">Home</a>
                        <span class="mx-1">/</span>
                        <span>{{ parent.title }}</span>
                    {% else %}
                        Home
                    {% endif %}
                </div>
            </div>

            <button class="btn btn-primary d-flex align-items-center gap-2" id="btn-open-modal">
                <i class="bi bi-plus-lg"></i>
                <span>New Resource</span>
            </button>
        </div>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'error' ? 'danger' : label }} py-2">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {% if resources is empty %}
            <div class="border rounded-3 p-4 text-center text-muted">
                No resources in this folder.
            </div>
        {% else %}
            <table class="table align-middle mb-0">
                <thead class="small text-muted">
                    <tr>
                        <th>Name</th>
                        <th style="width: 120px;">Type</th>
                        <th style="width: 120px;">Size</th>
                        <th style="width: 180px;">Created</th>
                        <th style="width: 120px;"></th>
                    </tr>
                </thead>
                <tbody>
                {% for resource in resources %}
                    <tr class="resource-row">
                        <td>
                            {% if resource.resourceType == 'folder' %}
                                <i class="bi bi-folder me-1 text-warning"></i>
                                <a href="{{ path('app_resources_index', { parent: resource.id }) }}">
                                    {{ resource.title }}
                                </a>
                            {% else %}
                                <i class="bi bi-file-earmark-text me-1 text-secondary"></i>
                                <a href="{{ path('app_resources_show', { id: resource.id }) }}">
                                    {{ resource.title }}
                                </a>
                            {% endif %}
                            {% if not resource.isPublic %}
                                <span class="badge bg-light text-muted border ms-1">
                                    <i class="bi bi-lock"></i> Private
                                </span>
                            {% else %}
                                <span class="badge bg-light text-muted border ms-1">
                                    <i class="bi bi-globe"></i> Public
                                </span>
                            {% endif %}
                        </td>
                        <td class="small text-muted">
                            {{ resource.resourceType|capitalize }}
                        </td>
                        <td class="small text-muted">
                            {% if resource.resourceType != 'folder' %}
                                {{ (resource.size / 1024)|number_format(1, ',', ' ') }} Ko
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="small text-muted">
                            {{ resource.createdAt|date('d/m/Y H:i') }}
                        </td>
                        <td class="text-end">
                            {% if resource.resourceType != 'folder' %}
                                <a href="/api/v1/resources/{{ resource.id }}/download"
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </section>
</div>

{# Modal création #}
<div class="modal-overlay" id="create-modal-overlay" style="display: none;">
    <div class="modal-backdrop-custom"></div>
    <div class="modal-dialog-centered-custom">
        <div class="modal-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Create New Resource</h5>
                <button type="button" class="btn-close" id="btn-close-modal"></button>
            </div>

                <form method="post" action="{{ path('app_resources_new') }}" id="create-resource-form" enctype="multipart/form-data">
        <input type="hidden" name="parent_id" value="{{ parent ? parent.id : '' }}">

        <div class="mb-3">
            <label class="form-label d-block">Resource Type</label>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="resource_type" id="type-folder" value="folder" checked>
                <label class="btn btn-outline-primary" for="type-folder">
                    <i class="bi bi-folder"></i> Folder
                </label>

                <input type="radio" class="btn-check" name="resource_type" id="type-file" value="file">
                <label class="btn btn-outline-primary" for="type-file">
                    <i class="bi bi-file-earmark"></i> File
                </label>
            </div>
        </div>

        <div class="mb-3">
            <label for="name-input" class="form-label">Name</label>
            <input type="text" class="form-control" id="name-input" name="name"
                placeholder="Enter folder or file name" required>
        </div>

        {# Type logique du fichier #}
        <div class="mb-3" id="file-type-row" style="display: none;">
            <label for="file-kind" class="form-label">File kind</label>
            <select id="file-kind" name="file_kind" class="form-select">
                <option value="document">Document</option>
                <option value="image">Image</option>
                <option value="video">Video</option>
                <option value="presentation">Presentation</option>
            </select>
            <small class="text-muted">
                Les images sont limitées à : .jpg, .jpeg, .png
            </small>
        </div>

        {# Upload réel #}
        <div class="mb-3" id="file-upload-row" style="display: none;">
            <label for="uploaded-file" class="form-label">File</label>
            <input type="file" class="form-control" id="uploaded-file" name="uploaded_file"
                accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.ppt,.pptx,.mp4,.avi,.mkv">
        </div>

        <div class="mb-3">
            <label class="form-label d-block">Visibility</label>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="visibility" id="visibility-private" value="private" checked>
                <label class="btn btn-outline-secondary" for="visibility-private">
                    <i class="bi bi-lock"></i> Private
                </label>

                <input type="radio" class="btn-check" name="visibility" id="visibility-public" value="public">
                <label class="btn btn-outline-secondary" for="visibility-public">
                    <i class="bi bi-globe"></i> Public
                </label>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" id="btn-cancel-modal">Cancel</button>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Create
            </button>
        </div>
    </form>

        </div>
    </div>
</div>
{% endblock %}

    {% block javascripts %}
    <script>
        (function () {
            const openBtn = document.getElementById('btn-open-modal');
            const overlay = document.getElementById('create-modal-overlay');
            const closeBtn = document.getElementById('btn-close-modal');
            const cancelBtn = document.getElementById('btn-cancel-modal');

            const typeFolder = document.getElementById('type-folder');
            const typeFile = document.getElementById('type-file');
            const fileTypeRow = document.getElementById('file-type-row');
            const fileUploadRow = document.getElementById('file-upload-row');

            function toggleFileFields() {
                const isFile = typeFile.checked;
                fileTypeRow.style.display = isFile ? 'block' : 'none';
                fileUploadRow.style.display = isFile ? 'block' : 'none';
            }

            function openModal() {
                overlay.style.display = 'block';
                toggleFileFields();
            }
            function closeModal() {
                overlay.style.display = 'none';
            }

            if (openBtn) openBtn.addEventListener('click', openModal);
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) closeModal();
                });
            }

            if (typeFolder && typeFile) {
                typeFolder.addEventListener('change', toggleFileFields);
                typeFile.addEventListener('change', toggleFileFields);
            }
        })();
    </script>
    {% endblock %}

